<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ shop.name }} - Billing System</title>
    <style>
        :root { --primary: #007bff; --secondary: #28a745; --dark: #2c3e50; --light: #f8f9fa; --whatsapp: #25D366; --pdf: #6f42c1; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; padding: 10px; background: #f0f2f5; color: #333; margin: 0; }
        .container { max-width: 900px; background: white; padding: 25px; border-radius: 12px; margin: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* Navigation Styles */
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .nav-links { display: flex; gap: 10px; flex-wrap: wrap; }
        .nav-btn { text-decoration: none; font-weight: bold; font-size: 13px; padding: 8px 14px; border-radius: 6px; transition: 0.2s; display: flex; align-items: center; color: white; }
        .btn-gallery { background: var(--pdf); }
        .btn-records { background: var(--secondary); }
        .btn-settings { border: 1px solid var(--primary); color: var(--primary); }
        .btn-settings:hover { background: var(--primary); color: white; }

        /* Header Inputs */
        .header-inputs { display: flex; justify-content: space-between; gap: 15px; margin-bottom: 20px; background: var(--light); padding: 15px; border-radius: 10px; border: 1px solid #e0e0e0; }
        .box-label { font-size: 11px; color: #666; font-weight: bold; display: block; text-transform: uppercase; margin-bottom: 4px; }
        .small-input { border: none; border-bottom: 2px solid #ccc; font-size: 18px; padding: 4px; background: transparent; width: 100%; outline: none; font-weight: bold; color: var(--dark); }

        h1 { text-align: center; color: var(--dark); margin: 5px 0; font-size: 1.8rem; }
        p.subtitle { text-align: center; font-size: 0.9em; color: #666; margin-bottom: 25px; }

        .grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 15px; }
        @media (min-width: 600px) { .grid { grid-template-columns: 1fr 1fr 1fr; } .span-2 { grid-column: span 2; } }
        
        label { font-weight: 600; font-size: 0.85em; color: #555; margin-bottom: 5px; display: block; }
        input, select { padding: 12px; width: 100%; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }

        /* Dynamic Items */
        .item-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; background: #fff; padding: 12px; border: 1px dashed #bbb; border-radius: 8px; align-items: center; }
        .item-row select { flex: 2; min-width: 150px; }
        .item-row input { flex: 1; min-width: 80px; }
        
        .btn { padding: 14px 20px; cursor: pointer; border: none; font-weight: bold; border-radius: 8px; transition: 0.3s; font-size: 15px; width: 100%; margin-bottom: 10px; }
        .btn-add { background: #e3f2fd; color: var(--primary); border: 1px solid var(--primary); }
        .btn-save { background: var(--secondary); color: white; font-size: 1.1em; margin-top: 15px; }

        /* Live Total Box */
        .live-box { background: #fff9c4; padding: 18px; margin-top: 25px; border-radius: 12px; border: 2px solid #fbc02d; position: sticky; bottom: 15px; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); }
        .live-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center; }
        .live-val { font-size: 1.2em; font-weight: 800; display: block; color: var(--dark); }

        /* Success & WhatsApp */
        .success-area { margin-top: 35px; padding: 25px; border: 2px solid var(--secondary); border-radius: 12px; background: #f1f8e9; text-align: center; }
        .whatsapp-btn { background: var(--whatsapp); color: white; text-decoration: none; display: flex; align-items: center; justify-content: center; font-size: 1.1em; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-nav">
        <div class="nav-links">
            <a href="/bill_gallery" class="nav-btn btn-gallery">üìÅ PDF Gallery</a>
            <a href="/records" class="nav-btn btn-records">üìä View Records</a>
            <a href="/admin" class="nav-btn btn-settings">‚öôÔ∏è Settings</a>
        </div>
        <span style="font-size: 12px; color: #888;">System Secure üîí</span>
    </div>

    <form id="mainForm" method="POST">
        <div class="header-inputs">
            <div style="flex: 1;">
                <label class="box-label">Code (Rate/10)</label>
                <input type="number" step="0.01" name="math_rate" id="mathRate" class="small-input" oninput="syncMarketRate(); calculateEverything();" placeholder="0.00" required>
            </div>
            <div style="flex: 1; text-align: right;">
                <label class="box-label">Extra Adj %</label>
                <input type="number" step="0.01" name="extra_adj" id="extraAdj" class="small-input" oninput="calculateEverything()" value="0">
            </div>
        </div>

        <h1>{{ shop.name }}</h1>
        <p class="subtitle">{{ shop.address }} | üìû {{ shop.mobile }}</p>
        
        <div class="grid">
            <div class="span-2">
                <label>Customer Name:</label>
                <input name="customer" placeholder="Enter Full Name" required>
            </div>
            <div>
                <label>Mobile No:</label>
                <input name="mobile" placeholder="10-digit mobile" required>
            </div>
        </div>

        <div class="grid">
            <div>
                <label>Metal Type:</label>
                <select name="metal" id="metalSelect" onchange="updateItemDropdowns(); syncMarketRate(); calculateEverything();">
                    <option value="Gold">Gold</option>
                    <option value="Silver">Silver</option>
                </select>
            </div>
            <div id="purityBox">
                <label>Purity:</label>
                <select name="purity" id="purity" onchange="syncMarketRate(); calculateEverything()">
                    <option value="75">18K (75%)</option>
                    <option value="84">20K (84%)</option>
                    <option value="92">22K (91.6%)</option>
                </select>
            </div>
            <div>
                <label>Display Rate (Market):</label>
                <input type="text" name="display_rate" id="displayRate" placeholder="e.g. 78,000">
            </div>
        </div>

        <hr style="border: 0.5px solid #eee; margin: 20px 0;">

        <p><b>Items Being Sold:</b></p>
        <div id="itemList"></div>
        <button type="button" class="btn btn-add" onclick="addItem()">+ Add Item from Stock</button>

        <div class="grid" style="margin-top: 20px;">
            <div>
                <label>Net Weight (gm):</label>
                <input type="number" step="0.001" id="netWeight" name="net_weight" oninput="calculateEverything()" required>
            </div>
            <div>
                <label style="color: #d32f2f;">Old Weight Return (-):</label>
                <input type="number" step="0.001" id="oldWeight" name="old_weight" value="0" oninput="calculateEverything()">
            </div>
            <div>
                <label id="makingLabel">Making %:</label>
                <input type="number" step="0.01" id="making" name="making" value="0" oninput="calculateEverything()">
            </div>
        </div>

        <div class="grid">
            <div><label>GST %:</label><input type="number" step="0.01" id="gstPer" name="gst_per" value="3" oninput="calculateEverything()"></div>
            <div><label>Discount (Rs):</label><input type="number" step="1" id="discount" name="discount" value="0" oninput="calculateEverything()"></div>
            <div><label>Paid Amount (Rs):</label><input type="number" step="1" id="paid" name="paid_amount" value="0" oninput="calculateEverything()"></div>
        </div>

        <div class="live-box">
            <div class="live-grid">
                <div><span style="font-size: 11px;">TOTAL</span><span id="viewTotal" class="live-val">‚Çπ 0</span></div>
                <div><span style="font-size: 11px;">PAID</span><span id="viewPaid" class="live-val">‚Çπ 0</span></div>
                <div><span style="font-size: 11px;">DUE</span><span id="viewBalance" class="live-val" style="color:#e74c3c;">‚Çπ 0</span></div>
            </div>
        </div>

        <button type="submit" class="btn btn-save">SAVE BILL & UPDATE STOCK</button>
    </form>

    {% if bill %}
    <div class="success-area">
        <h2 style="color: var(--secondary); margin-top: 0;">‚úì Transaction Saved</h2>
        <div style="display: flex; flex-direction: column; gap: 10px; max-width: 400px; margin: auto;">
            <form method="POST" action="/pdf">
                {% for key, value in bill.items() %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
                {% endfor %}
                <button type="submit" class="btn" style="background:var(--primary); color:white;">üì• DOWNLOAD PDF</button>
            </form>

            <a href="https://wa.me/91{{ bill.Mobile }}?text=Hello%20{{ bill.Customer }},%20your%20bill%20from%20{{ shop.name }}%20is%20ready.%20Total:%20Rs.{{ bill.Total }}." 
               target="_blank" class="btn whatsapp-btn">
                SEND VIA WHATSAPP
            </a>
        </div>
    </div>
    {% endif %}
</div>

<script>
const goldItems = {{ gold_list|tojson }};
const silverItems = {{ silver_list|tojson }};

function syncMarketRate() {
    const mathRate = parseFloat(document.getElementById("mathRate").value || 0);
    const purity = parseFloat(document.getElementById("purity").value || 75);
    const metal = document.getElementById("metalSelect").value;
    const displayRateInput = document.getElementById("displayRate");

    if (mathRate > 0) {
        let calculatedRate;
        if (metal === "Gold") {
            // Market Rate = (Code * Purity%) 
            // This effectively divides the usual rate by 10 relative to the mathRate logic
            calculatedRate = Math.round(mathRate * (purity / 100));
        } else {
            calculatedRate = mathRate; 
        }
        displayRateInput.value = calculatedRate;
    }
}

function updateItemDropdowns() {
    const metal = document.getElementById("metalSelect").value;
    const dropdowns = document.querySelectorAll(".item-name-select");
    const items = (metal === "Gold") ? goldItems : silverItems;
    dropdowns.forEach(select => {
        const currentVal = select.value;
        select.innerHTML = '<option value="">Select Item</option>';
        items.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item; opt.innerText = item;
            select.appendChild(opt);
        });
        select.value = currentVal;
    });
}

function addItem() {
    const metal = document.getElementById("metalSelect").value;
    const items = (metal === "Gold") ? goldItems : silverItems;
    const div = document.createElement("div");
    div.className = "item-row";
    let options = '<option value="">Select Item</option>';
    items.forEach(item => { options += `<option value="${item}">${item}</option>`; });
    div.innerHTML = `
        <select name="item_name[]" class="item-name-select" required>${options}</select>
        <input type="number" step="0.001" name="item_weight[]" class="w-in" placeholder="Weight" oninput="updateTotalWeight()" required>
        <button type="button" onclick="this.parentElement.remove(); updateTotalWeight();" style="color:red; border:none; background:none; cursor:pointer; font-size:20px;">‚úï</button>
    `;
    document.getElementById("itemList").appendChild(div);
}

function updateTotalWeight() {
    let totalW = 0; 
    document.querySelectorAll(".w-in").forEach(input => { totalW += parseFloat(input.value || 0); });
    if (totalW > 0) document.getElementById("netWeight").value = totalW.toFixed(3);
    calculateEverything();
}

function calculateEverything() {
    const metal = document.getElementById("metalSelect").value;
    document.getElementById("purityBox").style.display = (metal === "Gold") ? "block" : "none";
    document.getElementById("makingLabel").innerText = (metal === "Gold") ? "Making %:" : "Making Fixed (Rs):";

    let mathRate = parseFloat(document.getElementById("mathRate").value || 0);
    let netW = parseFloat(document.getElementById("netWeight").value || 0);
    let oldW = parseFloat(document.getElementById("oldWeight").value || 0);
    let making = parseFloat(document.getElementById("making").value || 0);
    let extraAdj = parseFloat(document.getElementById("extraAdj").value || 0);
    let gstPer = parseFloat(document.getElementById("gstPer").value || 0);
    let disc = parseFloat(document.getElementById("discount").value || 0);
    let paid = parseFloat(document.getElementById("paid").value || 0);
    
    let total = 0;
    let billingW = netW - oldW;

    if (mathRate > 0 && billingW > 0) {
        if (metal === "Gold") {
            let purity = parseFloat(document.getElementById("purity").value);
            let baseVal = (mathRate / 10) * billingW;
            let metalAmt = baseVal * (purity / 100);
            let makingAmt = baseVal * ((making + extraAdj) / 100);
            let subtotal = metalAmt + makingAmt;
            let totalWithGst = subtotal + (subtotal * (gstPer / 100));
            // Apply 0.2911% more for gold section
            total = totalWithGst * 1.002911;
        } else {
            let metalAmt = (mathRate / 1000) * billingW;
            let makingAmt = making + (metalAmt * (extraAdj / 100));
            let subtotal = metalAmt + makingAmt;
            total = subtotal + (subtotal * (gstPer / 100));
        }
    }
    let finalTotal = Math.round(Math.max(0, total - disc));
    let balance = finalTotal - paid;
    document.getElementById("viewTotal").innerText = "‚Çπ " + finalTotal.toLocaleString('en-IN');
    document.getElementById("viewPaid").innerText = "‚Çπ " + Math.round(paid).toLocaleString('en-IN');
    document.getElementById("viewBalance").innerText = "‚Çπ " + Math.round(balance).toLocaleString('en-IN');
}
</script>
</body>
</html>